@implements IDisposable

<div class="col-xs-12">
    <div class="details-section-header">
        <h5>MOST RECENT TEST RESULTS (REGRESSION)</h5>
    </div>
    <div class="details-section-body">
        @if (LatestBatch?.HedgeRegressionBatchResults != null && LatestBatch.HedgeRegressionBatchResults.Any())
        {
            <div class="regression-container">
                <div class="left-panel">
                    <div class="">
                        <!-- Statistical Summary (Positioned Above the Chart) -->
                        <div class="custom-stats-container">
                            <div class="stats-section">
                                <div class="stat-box">
                                    <p class="stat-label">Slope</p>
                                    <p class="stat-value">@GetSlopeValue()</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-label">Std Error</p>
                                    <p class="stat-value">@GetStandardErrorValue()</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-label">t-Test</p>
                                    <p class="stat-value">@((MarkupString)GetTTestValue())</p>
                                </div>
                            </div>
                            <div class="stats-section">
                                <div class="stat-box">
                                    <p class="stat-label">R</p>
                                    <p class="stat-value">@GetRValue()</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-label">Obs</p>
                                    <p class="stat-value">@GetObservationValue()</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-label">Significance</p>
                                    <p class="stat-value">@GetSignificanceValue()</p>
                                </div>
                            </div>
                            <div class="stats-section">
                                <div class="stat-box">
                                    <p class="stat-label">R²</p>
                                    <p class="stat-value">@GetRSquaredValue()</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-label">y-Intercept</p>
                                    <p class="stat-value">@GetYInterceptValue()</p>
                                </div>
                                <div class="stat-box">
                                    <p class="stat-label">F-Stat</p>
                                    <p class="stat-value">@((MarkupString)GetFStatValue())</p>
                                </div>
                            </div>
                        </div>

                        <!-- Regression Analysis Chart -->
                        <SfChart @key="@(LatestBatch?.ID ?? 0)"
                                 Title=""
                                 Background="@CHART_BACKGROUND_COLOR"
                                 Width="100%"
                                 Height="@($"{CHART_HEIGHT}px")">
                            <!-- Primary X-Axis Configuration -->
                            <ChartPrimaryXAxis Title=""
                                               Minimum="@ChartMinValue"
                                               Maximum="@ChartMaxValue"
                                               LabelFormat="C0"
                                               LineStyle="@(new ChartAxisLineStyle { Width = 0 })">
                                <ChartAxisMajorGridLines Width="1" Color="@CHART_GRID_COLOR"></ChartAxisMajorGridLines>
                                <ChartAxisLabelStyle Size="8px" Color="white"></ChartAxisLabelStyle>
                            </ChartPrimaryXAxis>

                            <!-- Primary Y-Axis Configuration -->
                            <ChartPrimaryYAxis Title=""
                                               Minimum="@ChartMinValue"
                                               Maximum="@ChartMaxValue"
                                               LabelFormat="C0"
                                               LineStyle="@(new ChartAxisLineStyle { Width = 0 })">
                                <ChartAxisMajorGridLines Width="1" Color="@CHART_GRID_COLOR"></ChartAxisMajorGridLines>
                                <ChartAxisLabelStyle Size="8px" Color="white"></ChartAxisLabelStyle>
                            </ChartPrimaryYAxis>

                            <!-- Chart Area Configuration -->
                            <ChartArea Background="@CHART_PLOT_BACKGROUND_COLOR">
                                <ChartAreaBorder Width="1" Color="@CHART_GRID_COLOR"></ChartAreaBorder>
                            </ChartArea>

                            <!-- Series Collection -->
                            <ChartSeriesCollection>
                                <!-- Scatter Plot for Data Points -->
                                <ChartSeries DataSource="@ChartData"
                                             XName="XValue"
                                             YName="YValue"
                                             Type="ChartSeriesType.Scatter"
                                             Name="Fair Value Changes"
                                             Fill="@CHART_SCATTER_COLOR">
                                    <ChartMarker Visible="true" Width="@CHART_MARKER_SIZE" Height="@CHART_MARKER_SIZE" Fill="@CHART_SCATTER_COLOR"></ChartMarker>
                                </ChartSeries>

                                <!-- Trendline -->
                                <ChartSeries DataSource="@TrendlineData"
                                             XName="XValue"
                                             YName="YValue"
                                             Type="ChartSeriesType.Line"
                                             Name="Trendline"
                                             Width="@TRENDLINE_WIDTH"
                                             Fill="@CHART_TRENDLINE_COLOR">
                                    <ChartMarker Visible="false"></ChartMarker>
                                </ChartSeries>
                            </ChartSeriesCollection>

                            <!-- Legend Configuration -->
                            <ChartLegendSettings Visible="false"></ChartLegendSettings>

                            <!-- Tooltip Configuration -->
                            <ChartTooltipSettings Enable="true"></ChartTooltipSettings>

                            <!-- Chart Margins -->
                            <ChartMargin Left="20" Right="20" Top="20" Bottom="20"></ChartMargin>
                        </SfChart>

                        <!-- Chart Credits (positioned at bottom right) -->
                        <div style="position: relative; margin-top: -27px; text-align: right; padding-right: 20px;">
                            <span style="color: white; font-size: 10px; font-family: Arial;">Derivative Path Inc</span>
                        </div>
                    </div>
                </div>
                <div class="right-panel">
                    <div style="height: calc(100vh - 14rem)">
                        <DefaultGrid DataSource="@(LatestBatch?.HedgeRegressionBatchResults)"
                                     TRowItem="DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM"
                                     Height="100%"
                                     ID="regression-grid"
                                     AllowPaging="false"
                                     AllowSorting="true"
                                     AllowGrouping="false"
                                     AllowFiltering="false"
                                     AllowSelection="false"
                                     EnableVirtualization="false"
                                     EnableGlobalSearch="true"
                                     ShowColumnMenu="false"
                                     ShowToolBar="false"
                                     ShowExcelExportButton="false"
                                     ShowColumnPickerButton="false"
                                     OnQueryCellInfo="OnQueryCellInfoHandler">
                            <GridColumns>
                                <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM.ObservationIndex)" HeaderText="Obs. Index" />
                                <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM.ValueDate)" HeaderText="Curve Date">
                                    <Template>
                                        @{
                                            var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM)context;
                                        }
                                        @(model.ValueDate.ToString("MM/dd/yyyy"))
                                    </Template>
                                </GridColumn>
                                <GridColumn HeaderText="@(IsIntrinsicValues() ? "Intrinsic Values" : "Fair Values")" HeaderTextAlign="TextAlign.Center">
                                    <GridColumns>
                                        <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM.HedgedFairValue)" HeaderText="@($"Hedged Item (DPI {LatestBatch?.HedgedRelationshipItem?.ItemID ?? "N/A"})")" HeaderTextAlign="TextAlign.Left" TextAlign="TextAlign.Right">
                                            <Template>
                                                @{
                                                    var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM)context;
                                                }
                                                <span class="@(model.HedgedFairValue > 0 ? "positive-numbers" : model.HedgedFairValue < 0 ? "negative-numbers" : "")">
                                                    @(model.HedgedFairValue == 0 ? "-" : string.Format("{0:$#,##0.00;($#,##0.00)}", model.HedgedFairValue))
                                                </span>
                                            </Template>
                                        </GridColumn>
                                        <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM.HedgingFairValue)" HeaderText="@($"Hedging Item (DPI {LatestBatch?.HedgingRelationshipItem?.ItemID ?? "N/A"})")" HeaderTextAlign="TextAlign.Left" TextAlign="TextAlign.Right">
                                            <Template>
                                                @{
                                                    var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM)context;
                                                }
                                                <span class="@(model.HedgingFairValue > 0 ? "positive-numbers" : model.HedgingFairValue < 0 ? "negative-numbers" : "")">
                                                    @(model.HedgingFairValue == 0 ? "-" : string.Format("{0:$#,##0.00;($#,##0.00)}", model.HedgingFairValue))
                                                </span>
                                            </Template>
                                        </GridColumn>
                                    </GridColumns>
                                </GridColumn>
                                <GridColumn HeaderText="@(IsIntrinsicValues() ? "Intrinsic Value Changes" : "Fair Value Changes")" HeaderTextAlign="TextAlign.Center">
                                    <GridColumns>
                                        <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM.HedgedFairValueChanged)" HeaderText="@($"Hedged Item (DPI {LatestBatch?.HedgedRelationshipItem?.ItemID ?? "N/A"})")" HeaderTextAlign="TextAlign.Left" TextAlign="TextAlign.Right">
                                            <Template>
                                                @{
                                                    var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM)context;
                                                }
                                                <span class="@(model.HedgedFairValueChanged > 0 ? "positive-numbers" : model.HedgedFairValueChanged < 0 ? "negative-numbers" : "")">
                                                    @(model.HedgedFairValueChanged == 0 ? "-" : string.Format("{0:$#,##0.00;($#,##0.00)}", model.HedgedFairValueChanged))
                                                </span>
                                            </Template>
                                        </GridColumn>
                                        <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM.HedgingFairValueChanged)" HeaderText="@($"Hedging Item (DPI {LatestBatch?.HedgingRelationshipItem?.ItemID ?? "N/A"})")" HeaderTextAlign="TextAlign.Left" TextAlign="TextAlign.Right">
                                            <Template>
                                                @{
                                                    var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM)context;
                                                }
                                                <span class="@(model.HedgingFairValueChanged > 0 ? "positive-numbers" : model.HedgingFairValueChanged < 0 ? "negative-numbers" : "")">
                                                    @(model.HedgingFairValueChanged == 0 ? "-" : string.Format("{0:$#,##0.00;($#,##0.00)}", model.HedgingFairValueChanged))
                                                </span>
                                            </Template>
                                        </GridColumn>  
                                    </GridColumns>
                                </GridColumn>
                                <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM.OptionTimeValue)" HeaderText="Time Value" HeaderTextAlign="TextAlign.Left" TextAlign="TextAlign.Right" Visible="@ShouldShowTimeValueColumns()">
                                    <Template>
                                        @{
                                            var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM)context;
                                        }
                                        <span class="@(model.OptionTimeValue > 0 ? "positive-numbers" : model.OptionTimeValue < 0 ? "negative-numbers" : "")">
                                            @(model.OptionTimeValue == 0 ? "-" : string.Format("{0:$#,##0.00;($#,##0.00)}", model.OptionTimeValue))
                                        </span>
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM.AdjustedValue)" HeaderText="Adjusted Value" HeaderTextAlign="TextAlign.Left" TextAlign="TextAlign.Right" Visible="@ShouldShowTimeValueColumns()">
                                    <Template>
                                        @{
                                            var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM)context;
                                        }
                                        <span class="@(model.AdjustedValue > 0 ? "positive-numbers" : model.AdjustedValue < 0 ? "negative-numbers" : "")">
                                            @(model.AdjustedValue == 0 ? "-" : string.Format("{0:$#,##0.00;($#,##0.00)}", model.AdjustedValue))
                                        </span>
                                    </Template>
                                </GridColumn>
                            </GridColumns>
                        </DefaultGrid>
                    </div>
                </div>
            </div>
        }
    </div>
    <div class="col-xs-12">
        <div class="details-section-header">
            <h5>ALL TESTS</h5>
        </div>
        <div class="details-section-body">
            @if (HedgeRegressionBatches != null && HedgeRegressionBatches.Any())
            {
                <div style="height: calc(100vh - 40rem)">
            <DefaultGrid DataSource="@(HedgeRegressionBatches ?? new List<DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM>())"
 TRowItem="DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM"
               ID="all-tests-grid"
         Height="100%"
        AllowPaging="false"
          AllowSorting="true"
 AllowGrouping="false"
       AllowFiltering="false"
  AllowSelection="false"
     EnableVirtualization="false"
   EnableGlobalSearch="true"
        ShowColumnMenu="false"
        ShowToolBar="false"
 ShowExcelExportButton="false"
  ShowColumnPickerButton="false"
OnRowClicked="OnRowSelected">
            <GridColumns>
                            <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM.RunDate)" HeaderText="Run Date">
                                <Template>
                                    @{
                                        var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM)context;
                                    }
                                    @{
                                        var dateValue = DateTime.TryParse(model.RunDate, out DateTime parsedDate)
                                        ? parsedDate.ToString("MM/dd/yyyy")
                                        : (model.RunDate ?? "-");
                                    }
                                    @dateValue
                                </Template>
                            </GridColumn>
                            <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM.ValueDate)" HeaderText="Curve Date">
                                <Template>
                                    @{
                                        var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM)context;
                                    }
                                    @{
                                        var dateValue = DateTime.TryParse(model.ValueDate, out DateTime parsedDate)
                                        ? parsedDate.ToString("MM/dd/yyyy")
                                        : (model.ValueDate ?? "-");
                                    }
                                    @dateValue
                                </Template>
                            </GridColumn>
                            <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM.HedgeResultType)" HeaderText="Result Type" />
                            <GridColumn HeaderText="Hedged Item">
                                <Template>
                                    @{
                                        var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM)context;
                                    }
                                    @(model.HedgedRelationshipItem?.ItemID)
                                </Template>
                            </GridColumn>
                            <GridColumn HeaderText="Hedging Item">
                                <Template>
                                    @{
                                        var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM)context;
                                    }
                                    @(model.HedgingRelationshipItem?.ItemID)
                                </Template>
                            </GridColumn>
                            <GridColumn HeaderText="Run By">
                                <Template>
                                    @{
                                        var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM)context;
                                    }
                                    @(model.RunBy?.Person?.FullName ?? "N/A")
                                </Template>
                            </GridColumn>
                            <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM.RetrospectiveDescription)" HeaderText="Retrospective" />
                            <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM.ProspectiveDescription)" HeaderText="Prospective" />
                            <GridColumn HeaderText="Action" TextAlign="TextAlign.Center" Freeze="FreezeDirection.Left" Width="80">
                                <Template>
                                    @{
                                        var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM)context;
                                        <SfDropDownButton CssClass="dp-menu-style">
                                            <DropDownButtonEvents ItemSelected="@((args) => OnItemSelectedMatrix(args, model))" />
                                            <DropDownMenuItems>
                                                <DropDownMenuItem Text="Download Excel" />
                                                @if (CanShowDeleteOption())
                                                {
                                                    <DropDownMenuItem Text="Delete" />
                                                }
                                            </DropDownMenuItems>
                                        </SfDropDownButton>
                                    }
                                </Template>
                            </GridColumn>
                        </GridColumns>
                    </DefaultGrid>
                </div>
            }
        </div>
    </div>
</div>

@* Delete Confirmation Modal - Legacy: confirm('Are you sure to delete the selected test?') *@
<DpConfirmationModal Visible="@_showDeleteConfirmation"
    VisibleChanged="@((bool v) => _showDeleteConfirmation = v)"
      Title="Confirm Delete"
   Message="Are you sure to delete the selected test?"
          ConfirmText="Delete"
  CancelText="Cancel"
         OnConfirmed="@HandleDeleteConfirmed"
     OnCancelled="@HandleDeleteCancelled" />

<style>
    /* Global styles to override Syncfusion grid - NOT scoped */
    
    /* Hide ALL checkbox-related elements */
    #all-tests-grid .e-selectioncheckbox,
    #all-tests-grid .e-checkselectall,
    #all-tests-grid .e-headerchkcelldiv,
    #all-tests-grid .e-checkbox-wrapper,
    #all-tests-grid .e-frame,
    #all-tests-grid .e-icons.e-check {
        display: none !important;
   visibility: hidden !important;
    }
    
    /* Hide checkbox column header - MORE SPECIFIC selectors */
    #all-tests-grid th.e-selectionheadercell {
     display: none !important;
 width: 0 !important;
  max-width: 0 !important;
padding: 0 !important;
        margin: 0 !important;
   border: none !important;
    }
    
    /* Hide checkbox column data cells - MORE SPECIFIC selectors */
    #all-tests-grid td.e-gridchkbox {
   display: none !important;
     width: 0 !important;
  max-width: 0 !important;
 padding: 0 !important;
     margin: 0 !important;
     border: none !important;
    }
    
    /* REMOVE nth-child(1) - was hiding Run Date column by mistake */
    /* Instead, disable AllowSelection in the grid markup or accept the column */
    
    /* Match header background to ALL TESTS section - EXACTLY #66666e */
    #all-tests-grid .e-gridheader {
      background-color: #66666e !important;
    }
    
    #all-tests-grid .e-gridheader th,
 #all-tests-grid .e-gridheader .e-headercell,
    #all-tests-grid .e-gridheader .e-headercelldiv {
     background-color: #66666e !important;
        color: white !important;
font-weight: normal !important;
    }
    
 /* Force ALL rows to white background - NO alternating colors */
 #all-tests-grid .e-row,
    #all-tests-grid .e-altrow,
    #all-tests-grid tbody tr {
    background-color: #ffffff !important;
    }
  
    #all-tests-grid .e-row td,
    #all-tests-grid .e-altrow td,
    #all-tests-grid tbody tr td {
    background-color: #ffffff !important;
    }
    
    /* Keep selected rows WHITE and VISIBLE - NO visual selection indicator */
    #all-tests-grid .e-row.e-selectionbackground,
    #all-tests-grid tr.e-selectionbackground {
   background-color: #ffffff !important;
    }
    
    #all-tests-grid .e-row.e-selectionbackground td,
  #all-tests-grid tr.e-selectionbackground td {
        background-color: #ffffff !important;
    }
    
    /* Subtle hover effect for better UX */
    #all-tests-grid .e-row:hover td {
      background-color: #f5f5f5 !important;
    }
</style>