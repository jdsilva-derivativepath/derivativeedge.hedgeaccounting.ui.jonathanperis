@using DerivativeEdge.HedgeAccounting.Api.Client
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Logging

@implements IDisposable

<div class="col-xs-12">
    <div class="details-section-header">
        <h5>MOST RECENT TEST RESULTS (REGRESSION)</h5>
    </div>
    <div class="details-section-body">
        <div class="regression-container">
            <div class="left-panel">
                <div class="">
                    <!-- Statistical Summary (Positioned Above the Chart) -->
                    <div class="custom-stats-container">
                        <div class="stats-section">
                            <div class="stat-box">
                                <p class="stat-label">Slope</p>
                                <p class="stat-value">@GetSlopeValue()</p>
                            </div>
                            <div class="stat-box">
                                <p class="stat-label">Std Error</p>
                                <p class="stat-value">@GetStandardErrorValue()</p>
                            </div>
                            <div class="stat-box">
                                <p class="stat-label">t-Test</p>
                                <p class="stat-value">@((MarkupString)GetTTestValue())</p>
                            </div>
                        </div>
                        <div class="stats-section">
                            <div class="stat-box">
                                <p class="stat-label">R</p>
                                <p class="stat-value">@GetRValue()</p>
                            </div>
                            <div class="stat-box">
                                <p class="stat-label">Obs</p>
                                <p class="stat-value">@GetObservationValue()</p>
                            </div>
                            <div class="stat-box">
                                <p class="stat-label">Significance</p>
                                <p class="stat-value">@GetSignificanceValue()</p>
                            </div>
                        </div>
                        <div class="stats-section">
                            <div class="stat-box">
                                <p class="stat-label">R²</p>
                                <p class="stat-value">@GetRSquaredValue()</p>
                            </div>
                            <div class="stat-box">
                                <p class="stat-label">y-Intercept</p>
                                <p class="stat-value">@GetYInterceptValue()</p>
                            </div>
                            <div class="stat-box">
                                <p class="stat-label">F-Stat</p>
                                <p class="stat-value">@((MarkupString)GetFStatValue())</p>
                            </div>
                        </div>
                    </div>

                    <!-- Regression Analysis Chart -->
                    <SfChart Title=""
                             Background="@CHART_BACKGROUND_COLOR"
                             Width="100%"
                             Height="@($"{CHART_HEIGHT}px")">
                        <!-- Primary X-Axis Configuration -->
                        <ChartPrimaryXAxis Title=""
                                           Minimum="@ChartMinValue"
                                           Maximum="@ChartMaxValue"
                                           LabelFormat="C0"
                                           LineStyle="@(new ChartAxisLineStyle { Width = 0 })">
                            <ChartAxisMajorGridLines Width="1" Color="@CHART_GRID_COLOR"></ChartAxisMajorGridLines>
                            <ChartAxisLabelStyle Size="8px" Color="white"></ChartAxisLabelStyle>
                        </ChartPrimaryXAxis>

                        <!-- Primary Y-Axis Configuration -->
                        <ChartPrimaryYAxis Title=""
                                           Minimum="@ChartMinValue"
                                           Maximum="@ChartMaxValue"
                                           LabelFormat="C0"
                                           LineStyle="@(new ChartAxisLineStyle { Width = 0 })">
                            <ChartAxisMajorGridLines Width="1" Color="@CHART_GRID_COLOR"></ChartAxisMajorGridLines>
                            <ChartAxisLabelStyle Size="8px" Color="white"></ChartAxisLabelStyle>
                        </ChartPrimaryYAxis>

                        <!-- Chart Area Configuration -->
                        <ChartArea Background="@CHART_PLOT_BACKGROUND_COLOR">
                            <ChartAreaBorder Width="1" Color="@CHART_GRID_COLOR"></ChartAreaBorder>
                        </ChartArea>

                        <!-- Series Collection -->
                        <ChartSeriesCollection>
                            <!-- Scatter Plot for Data Points -->
                            <ChartSeries DataSource="@ChartData"
                                         XName="XValue"
                                         YName="YValue"
                                         Type="ChartSeriesType.Scatter"
                                         Name="Fair Value Changes"
                                         Fill="@CHART_SCATTER_COLOR">
                                <ChartMarker Visible="true" Width="@CHART_MARKER_SIZE" Height="@CHART_MARKER_SIZE" Fill="@CHART_SCATTER_COLOR"></ChartMarker>
                            </ChartSeries>

                            <!-- Trendline -->
                            <ChartSeries DataSource="@TrendlineData"
                                         XName="XValue"
                                         YName="YValue"
                                         Type="ChartSeriesType.Line"
                                         Name="Trendline"
                                         Width="@TRENDLINE_WIDTH"
                                         Fill="@CHART_TRENDLINE_COLOR">
                                <ChartMarker Visible="false"></ChartMarker>
                            </ChartSeries>
                        </ChartSeriesCollection>

                        <!-- Legend Configuration -->
                        <ChartLegendSettings Visible="false"></ChartLegendSettings>

                        <!-- Tooltip Configuration -->
                        <ChartTooltipSettings Enable="true"></ChartTooltipSettings>

                        <!-- Chart Margins -->
                        <ChartMargin Left="20" Right="20" Top="20" Bottom="20"></ChartMargin>
                    </SfChart>

                    <!-- Chart Credits (positioned at bottom right) -->
                    <div style="position: relative; margin-top: -27px; text-align: right; padding-right: 20px;">
                        <span style="color: white; font-size: 10px; font-family: Arial;">Derivative Path Inc</span>
                    </div>
                </div>
            </div>
            <div class="right-panel">
                <div style="height: calc(100vh - 14rem)">
                    <DefaultGrid DataSource="@(LatestBatch?.HedgeRegressionBatchResults)"
                                 TRowItem="DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM"
                                 Height="100%"
                                 ID="regression-grid"
                                 AllowPaging="false"
                                 AllowSorting="true"
                                 AllowGrouping="false"
                                 AllowFiltering="false"
                                 AllowSelection="false"
                                 EnableVirtualization="false"
                                 EnableGlobalSearch="true"
                                 ShowColumnMenu="false"
                                 ShowToolBar="false"
                                 ShowExcelExportButton="false"
                                 ShowColumnPickerButton="false">
                        <GridColumns>
                            <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM.ObservationEvent)" HeaderText="Obs. Index" Width="80" />
                            <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM.ValueDate)" HeaderText="Curve Date" Width="120" />
                            <GridColumn HeaderText="Fair Values" HeaderTextAlign="TextAlign.Center">
                                <GridColumns>
                                    <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM.HedgedFairValue)" HeaderText="@($"Hedged Item (DPI {LatestBatch?.HedgedRelationshipItem?.ItemID ?? "N/A"})")" HeaderTextAlign="TextAlign.Left" TextAlign="TextAlign.Right">
                                        @*<HeaderTemplate> - still has a bug for css
                                            <span>Hedged Item<br />(DPI @(LatestBatch?.HedgedRelationshipItem?.ItemID ?? "N/A"))</span>
                                        </HeaderTemplate>*@
                                        <Template>
                                            @{
                                                var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM)context;
                                            }
                                            <span class="@(model.HedgedFairValue > 0 ? "" : "negative-numbers")">
                                                @string.Format("{0:$#,##0.00;($#,##0.00)}", model.HedgedFairValue)
                                            </span>
                                        </Template>
                                    </GridColumn>
                                    <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM.HedgingFairValue)" HeaderText="@($"Hedging Item (DPI {LatestBatch?.HedgingRelationshipItem?.ItemID ?? "N/A"})")" HeaderTextAlign="TextAlign.Left" TextAlign="TextAlign.Right">
                                        <Template>
                                            @{
                                                var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM)context;
                                            }
                                            <span class="@(model.HedgingFairValue > 0 ? "" : "negative-numbers")">
                                                @string.Format("{0:$#,##0.00;($#,##0.00)}", model.HedgingFairValue)
                                            </span>
                                        </Template>
                                    </GridColumn>
                                </GridColumns>
                            </GridColumn>
                            <GridColumn HeaderText="Fair Value Changes" HeaderTextAlign="TextAlign.Center">
                                <GridColumns>
                                    <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM.HedgedFairValueChanged)" HeaderText="@($"Hedged Item (DPI {LatestBatch?.HedgedRelationshipItem?.ItemID ?? "N/A"})")" HeaderTextAlign="TextAlign.Left" TextAlign="TextAlign.Right">
                                        <Template>
                                            @{
                                                var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM)context;
                                            }
                                            <span class="@(model.HedgedFairValueChanged > 0 ? "" : "negative-numbers")">
                                                @string.Format("{0:$#,##0.00;($#,##0.00)}", model.HedgedFairValueChanged)
                                            </span>
                                        </Template>
                                    </GridColumn>
                                    <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM.HedgingFairValueChanged)" HeaderText="@($"Hedging Item (DPI {LatestBatch?.HedgingRelationshipItem?.ItemID ?? "N/A"})")" HeaderTextAlign="TextAlign.Left" TextAlign="TextAlign.Right">
                                        <Template>
                                            @{
                                                var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchResultVM)context;
                                            }
                                            <span class="@(model.HedgingFairValueChanged > 0 ? "" : "negative-numbers")">
                                                @string.Format("{0:$#,##0.00;($#,##0.00)}", model.HedgingFairValueChanged)
                                            </span>
                                        </Template>
                                    </GridColumn>
                                </GridColumns>
                            </GridColumn>
                        </GridColumns>
                    </DefaultGrid>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xs-12">
        <div class="details-section-header">
            <h5>ALL TESTS</h5>
        </div>
        <div class="details-section-body">
            <div style="height: calc(100vh - 40rem)">
                <DefaultGrid DataSource="@(HedgeRegressionBatches ?? new List<DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM>())"
                             TRowItem="DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM"
                                Height="100%"
                                AllowPaging="false"
                                AllowSorting="true"
                                AllowGrouping="false"
                                AllowFiltering="false"
                                AllowSelection="false"
                                EnableVirtualization="false"
                                EnableGlobalSearch="true"
                                ShowColumnMenu="false"
                                ShowToolBar="false"
                                ShowExcelExportButton="false"
                                ShowColumnPickerButton="false">
                    <GridColumns>
                        <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM.RunDate)" HeaderText="Run Date" />
                        <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM.ValueDate)" HeaderText="Value Date" />
                        <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM.HedgeResultType)" HeaderText="Result Type" />
                        <GridColumn HeaderText="Hedged Item">
                            <Template>
                                @{
                                    var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM)context;
                                }
                                @(model.HedgedRelationshipItem?.ItemID)
                            </Template>
                        </GridColumn>
                        <GridColumn HeaderText="Hedging Item">
                            <Template>
                                @{
                                    var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM)context;
                                }
                                @(model.HedgingRelationshipItem?.ItemID)
                            </Template>
                        </GridColumn>
                        <GridColumn HeaderText="Run By">
                            <Template>
                                @{
                                    var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM)context;
                                }
                                @(model.RunBy?.Person?.FullName ?? "N/A")
                            </Template>
                        </GridColumn>
                        <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM.RetrospectiveDescription)" HeaderText="Retrospective" />
                        <GridColumn Field="@nameof(DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM.ProspectiveDescription)" HeaderText="Prospective" />
                        <GridColumn HeaderText="Action" TextAlign="TextAlign.Center" Freeze="FreezeDirection.Left" Width="80">
                            <Template>
                                @{
                                    var model = (DerivativeEDGEHAApiViewModelsHedgeRegressionBatchVM)context;
                                    <SfDropDownButton CssClass="dp-menu-style">
                                        <DropDownButtonEvents ItemSelected="@((args) => OnItemSelectedMatrix(args, model))" />
                                        <DropDownMenuItems>
                                            <DropDownMenuItem Text="Download Excel" />
                                            <DropDownMenuItem Text="Delete" />
                                        </DropDownMenuItems>
                                    </SfDropDownButton>
                                }
                            </Template>
                        </GridColumn>
                    </GridColumns>
                </DefaultGrid>
            </div>
        </div>
    </div>
</div>

@code {

}
